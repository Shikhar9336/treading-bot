import streamlit as st
import yfinance as yf
import pandas_ta as ta
import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import google.generativeai as genai

# --- рдкреЗрдЬ рд╕реЗрдЯрд┐рдВрдЧ ---
st.set_page_config(page_title="Shikhar Master Bot", page_icon="ЁЯХпя╕П", layout="wide")

# ЁЯФС API KEY
api_key = "AIzaSyDKx2IgsHmnCDYm7IDqUXzr9Yfu9yuFgls"
try:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel("gemini-pro")
except: pass

# --- ЁЯУЪ 25+ рдХреИрдВрдбрд▓реНрд╕ рдХреА рд╡рд┐рд╢рд╛рд▓ рд▓рд╛рдЗрдмреНрд░реЗрд░реА (Hindi Data) ---
CANDLE_LIBRARY = [
    # рддреЗрдЬреА рд╡рд╛рд▓реА рдХреИрдВрдбрд▓реНрд╕ (Bullish)
    {"name": "Hammer (рд╣рдереМрдбрд╝рд╛) ЁЯФи", "type": "Bullish", "desc": "рдмрд╛рдЬрд╛рд░ рдЧрд┐рд░рдиреЗ рдХреЗ рдмрд╛рдж рдмрдирддрд╛ рд╣реИред рдпрд╣ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдЕрдм рдорд╛рд░реНрдХреЗрдЯ рдКрдкрд░ рдЙрдареЗрдЧрд╛ред"},
    {"name": "Inverted Hammer ЁЯФи", "type": "Bullish", "desc": "рдЙрд▓реНрдЯрд╛ рд╣рдереМрдбрд╝рд╛ред рдпрд╣ рднреА рдЧрд┐рд░рд╛рд╡рдЯ рдХреЗ рдЕрдВрдд рдореЗрдВ рдмрдирддрд╛ рд╣реИ рдФрд░ рддреЗрдЬреА рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддрд╛ рд╣реИред"},
    {"name": "Bullish Engulfing ЁЯУИ", "type": "Strong Buy", "desc": "рдЫреЛрдЯреА рд▓рд╛рд▓ рдХреИрдВрдбрд▓ рдХреЛ рдЕрдЧрд▓реА рдмрдбрд╝реА рд╣рд░реА рдХреИрдВрдбрд▓ рдкреВрд░рд╛ рдирд┐рдЧрд▓ рд▓реЗрддреА рд╣реИред рдмрд╣реБрдд рддрдЧрдбрд╝реА рддреЗрдЬреАред"},
    {"name": "Morning Star ЁЯМЕ", "type": "Bullish Reversal", "desc": "3 рдХреИрдВрдбрд▓ рдХрд╛ рдкреИрдЯрд░реНрди: 1 рд▓рд╛рд▓, 1 рдЫреЛрдЯреА рдбреЛрдЬреА, 1 рд╣рд░реАред рд░рд╛рдд рдЧрдИ, рд╕рд╡реЗрд░рд╛ (рддреЗрдЬреА) рд╣реБрдЖред"},
    {"name": "Three White Soldiers ЁЯТВ", "type": "Super Bullish", "desc": "рд▓рдЧрд╛рддрд╛рд░ 3 рдмрдбрд╝реА рд╣рд░реА рдХреИрдВрдбрд▓реНрд╕ред рдЕрдм рдорд╛рд░реНрдХреЗрдЯ рд░реБрдХрдиреЗ рд╡рд╛рд▓рд╛ рдирд╣реАрдВ рд╣реИ, рдКрдкрд░ рдЬрд╛рдПрдЧрд╛ред"},
    {"name": "Piercing Line ЁЯМдя╕П", "type": "Bullish", "desc": "рд▓рд╛рд▓ рдХреИрдВрдбрд▓ рдХреЗ рдмрд╛рдж рд╣рд░реА рдХреИрдВрдбрд▓, рдЬреЛ рд▓рд╛рд▓ рдХреЗ рдЖрдзреЗ рд╕реЗ рдКрдкрд░ рдмрдВрдж рд╣реЛред"},
    {"name": "Tweezer Bottom ЁЯев", "type": "Bullish", "desc": "рджреЛ рдХреИрдВрдбрд▓реНрд╕ рдХрд╛ рдирд┐рдЪрд▓рд╛ рд╣рд┐рд╕реНрд╕рд╛ (Low) рдмрд░рд╛рдмрд░ рд╣реЛред рдпрд╣ рдордЬрдмреВрдд рд╕рдкреЛрд░реНрдЯ рд╣реИред"},
    {"name": "Marubozu Green ЁЯЯй", "type": "Full Power Buy", "desc": "рдмрд┐рдирд╛ рдбрдВрдбреА рдХреА рдмрдбрд╝реА рд╣рд░реА рдХреИрдВрдбрд▓ред рдЦрд░реАрджрд╛рд░ рдкреВрд░реА рддрд░рд╣ рд╣рд╛рд╡реА рд╣реИрдВред"},
    {"name": "Bullish Harami ЁЯд░", "type": "Bullish", "desc": "рдмрдбрд╝реА рд▓рд╛рд▓ рдХреИрдВрдбрд▓ рдХреЗ рдкреЗрдЯ рдореЗрдВ рдЫреЛрдЯреА рд╣рд░реА рдХреИрдВрдбрд▓ред рдЧрд┐рд░рд╛рд╡рдЯ рд░реБрдХ рдЧрдИ рд╣реИред"},
    
    # рдордВрджреА рд╡рд╛рд▓реА рдХреИрдВрдбрд▓реНрд╕ (Bearish)
    {"name": "Shooting Star ЁЯМа", "type": "Bearish", "desc": "рддреЗрдЬреА рдХреЗ рдмрд╛рдж рдКрдкрд░ рдмрдирддрд╛ рд╣реИред рдЕрдм рдорд╛рд░реНрдХреЗрдЯ рдЯреВрдЯрдХрд░ рдЧрд┐рд░рдиреЗ рд╡рд╛рд▓рд╛ рд╣реИред"},
    {"name": "Hanging Man ЁЯзШ", "type": "Bearish", "desc": "рдКрдкрд░ рдЬрд╛рддреЗ рдмрд╛рдЬрд╛рд░ рдореЗрдВ рд╣рдереМрдбрд╝рд╛ред рдпрд╣ рдЦрддрд░реЗ рдХреА рдШрдВрдЯреА рд╣реИ, рдмреЗрдЪ рджреЛред"},
    {"name": "Bearish Engulfing ЁЯУЙ", "type": "Strong Sell", "desc": "рдЫреЛрдЯреА рд╣рд░реА рдХреИрдВрдбрд▓ рдХреЛ рдЕрдЧрд▓реА рдмрдбрд╝реА рд▓рд╛рд▓ рдХреИрдВрдбрд▓ рдкреВрд░рд╛ рдирд┐рдЧрд▓ рд▓реЗрддреА рд╣реИред рднрд╛рд░реА рдЧрд┐рд░рд╛рд╡рдЯред"},
    {"name": "Evening Star ЁЯМГ", "type": "Bearish Reversal", "desc": "3 рдХреИрдВрдбрд▓: 1 рд╣рд░реА, 1 рдбреЛрдЬреА, 1 рд▓рд╛рд▓ред рджрд┐рди рдврд▓ рдЧрдпрд╛, рд░рд╛рдд (рдордВрджреА) рд╢реБрд░реВред"},
    {"name": "Three Black Crows ЁЯжЕ", "type": "Super Bearish", "desc": "рд▓рдЧрд╛рддрд╛рд░ 3 рдмрдбрд╝реА рд▓рд╛рд▓ рдХреИрдВрдбрд▓реНрд╕ред рдорд╛рд░реНрдХреЗрдЯ рдзрдбрд╝рд╛рдо рд╕реЗ рдЧрд┐рд░реЗрдЧрд╛ред"},
    {"name": "Dark Cloud Cover тШБя╕П", "type": "Bearish", "desc": "рд╣рд░реА рдХреИрдВрдбрд▓ рдХреЗ рдмрд╛рдж рд▓рд╛рд▓ рдХреИрдВрдбрд▓ рдЬреЛ рд╣рд░реА рдХреЗ рдЖрдзреЗ рд╕реЗ рдиреАрдЪреЗ рдмрдВрдж рд╣реЛред"},
    {"name": "Tweezer Top ЁЯев", "type": "Bearish", "desc": "рджреЛ рдХреИрдВрдбрд▓реНрд╕ рдХрд╛ рдКрдкрд░реА рд╣рд┐рд╕реНрд╕рд╛ (High) рдмрд░рд╛рдмрд░ рд╣реЛред рдпрд╣ рдордЬрдмреВрдд рд░реЗрдЬрд┐рд╕реНрдЯреЗрдВрд╕ рд╣реИред"},
    {"name": "Marubozu Red ЁЯЯе", "type": "Full Power Sell", "desc": "рдмрд┐рдирд╛ рдбрдВрдбреА рдХреА рдмрдбрд╝реА рд▓рд╛рд▓ рдХреИрдВрдбрд▓ред рдмреЗрдЪрдиреЗ рд╡рд╛рд▓реЗ рдкреВрд░реА рддрд░рд╣ рд╣рд╛рд╡реА рд╣реИрдВред"},
    {"name": "Bearish Harami ЁЯд░", "type": "Bearish", "desc": "рдмрдбрд╝реА рд╣рд░реА рдХреИрдВрдбрд▓ рдХреЗ рдкреЗрдЯ рдореЗрдВ рдЫреЛрдЯреА рд▓рд╛рд▓ рдХреИрдВрдбрд▓ред рддреЗрдЬреА рд░реБрдХ рдЧрдИ рд╣реИред"},

    # рдХрдиреНрдлреНрдпреВрдЬрди рд╡рд╛рд▓реА (Neutral)
    {"name": "Doji (рдбреЛрдЬреА) тЮХ", "type": "Neutral", "desc": "рдЬрд╣рд╛рдБ рдЦреБрд▓рд╛ рд╡рд╣реАрдВ рдмрдВрджред рдорд╛рд░реНрдХреЗрдЯ рдХрдиреНрдлреНрдпреВрдЬ рд╣реИред рдЕрднреА рдЯреНрд░реЗрдб рди рд▓реЗрдВред"},
    {"name": "Spinning Top ЁЯМкя╕П", "type": "Neutral", "desc": "рдЫреЛрдЯреА рдмреЙрдбреА, рджреЛрдиреЛрдВ рддрд░рдл рд▓рдВрдмреА рдбрдВрдбреАред рдмрд╛рдЬрд╛рд░ рдореЗрдВ рдЯрдХреНрдХрд░ рдЪрд▓ рд░рд╣реА рд╣реИред"},
]

# --- рд╕рд╛рдЗрдбрдмрд╛рд░ ---
with st.sidebar:
    st.header("ЁЯСд рдЯреНрд░реЗрдбрд░ рдкреНрд░реЛрдлрд╛рдЗрд▓")
    st.info("рд╢рд┐рдЦрд░ рддрд┐рд╡рд╛рд░реА (рдИрд╢рд╛рди рдкрдВрдбрд┐рдд)")
    st.success("ЁЯУ▒ 93360-92738")
    st.markdown("---")

st.title("ЁЯХпя╕П рд╢рд┐рдЦрд░ рддрд┐рд╡рд╛рд░реА - рдорд╛рд╕реНрдЯрд░ рдЪрд╛рд░реНрдЯ & рдХреИрдВрдбрд▓реНрд╕")

# --- рдорд╛рд░реНрдХреЗрдЯ рд╕рд┐рд▓реЗрдХреНрд╢рди ---
st.sidebar.header("ЁЯФН рдорд╛рд░реНрдХреЗрдЯ рдЪреБрдиреЗрдВ")
market_cat = st.sidebar.radio("рд╕реЗрдЧрдореЗрдВрдЯ:", ("ЁЯЗоЁЯЗ│ рдЗрдВрдбрд┐рдпрди рдорд╛рд░реНрдХреЗрдЯ", "ЁЯТ▒ рдлреЙрд░реЗрдХреНрд╕ & рдЧреЛрд▓реНрдб", "ЁЯЗ║ЁЯЗ╕ рдЧреНрд▓реЛрдмрд▓ рдорд╛рд░реНрдХреЗрдЯ", "тВ┐ рдХреНрд░рд┐рдкреНрдЯреЛ"))

symbol = ""
if market_cat == "ЁЯЗоЁЯЗ│ рдЗрдВрдбрд┐рдпрди рдорд╛рд░реНрдХреЗрдЯ":
    option = st.sidebar.selectbox("рд╕реНрдЯреЙрдХ:", ("NIFTY 50", "BANK NIFTY", "RELIANCE", "TATA MOTORS", "HDFC BANK"))
    symbol = "^NSEI" if "NIFTY" in option else "^NSEBANK" if "BANK" in option else f"{option.replace(' ', '')}.NS"
elif market_cat == "ЁЯТ▒ рдлреЙрд░реЗрдХреНрд╕ & рдЧреЛрд▓реНрдб":
    option = st.sidebar.selectbox("рдкреЗрдпрд░:", ("GOLD (XAU/USD)", "SILVER", "GBP/USD", "EUR/USD"))
    if "GOLD" in option: symbol = "GC=F"
    elif "SILVER" in option: symbol = "SI=F"
    elif "GBP" in option: symbol = "GBPUSD=X"
    elif "EUR" in option: symbol = "EURUSD=X"
elif market_cat == "ЁЯЗ║ЁЯЗ╕ рдЧреНрд▓реЛрдмрд▓ рдорд╛рд░реНрдХреЗрдЯ":
    symbol = "^IXIC"
elif market_cat == "тВ┐ рдХреНрд░рд┐рдкреНрдЯреЛ":
    symbol = "BTC-USD"

timeframe = st.sidebar.selectbox("рдЯрд╛рдЗрдордлреНрд░реЗрдо:", ("1 Minute", "5 Minutes", "15 Minutes", "1 Hour", "1 Day"))

# --- рдЯреИрдмреНрд╕ ---
tab1, tab2, tab3 = st.tabs(["ЁЯУК рд▓рд╛рдЗрд╡ рдЪрд╛рд░реНрдЯ & рд╕рд┐рдЧреНрдирд▓реНрд╕", "ЁЯУЪ рдХреИрдВрдбрд▓ рд▓рд╛рдЗрдмреНрд░реЗрд░реА (25+)", "ЁЯдЦ AI рдЧреБрд░реБрдЬреА"])

# TAB 1: рдЪрд╛рд░реНрдЯ рдФрд░ рд╕рд┐рдЧреНрдирд▓
with tab1:
    if st.button(f"{symbol} рд╕реНрдХреИрди рдХрд░реЗрдВ ЁЯЪА"):
        with st.spinner('рдбреЗрдЯрд╛ рдЖ рд░рд╣рд╛ рд╣реИ...'):
            try:
                p, i = ("1y", "1d")
                if "1 Minute" in timeframe: p, i = "5d", "1m"
                elif "5 Minutes" in timeframe: p, i = "5d", "5m"
                elif "15 Minutes" in timeframe: p, i = "1mo", "15m"
                elif "1 Hour" in timeframe: p, i = "1y", "1h"

                df = yf.Ticker(symbol).history(period=p, interval=i)
                
                if df.empty: st.error("тЭМ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛")
                else:
                    df['EMA_9'] = df.ta.ema(length=9)
                    df['EMA_21'] = df.
